<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>A few things you need to know about Megatron-LM DistributedOptimizer | Jianbin Chang</title> <meta name="author" content="Jianbin Chang"> <meta name="description" content="Nice blog. "> <meta name="keywords" content="shjwudp"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%A5%9F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://shjwudp.github.io/blog/2023/you-need-to-know-about-megatron-lm-distributedoptimizer/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Jianbin </span>Chang</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/"></a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">A few things you need to know about Megatron-LM DistributedOptimizer</h1> <p class="post-meta">October 27, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/megatron-lm"> <i class="fas fa-hashtag fa-sm"></i> Megatron-LM</a>     ·   <a href="/blog/category/note"> <i class="fas fa-tag fa-sm"></i> note</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>The Megatron-LM distributed optimizer is a code with a complex interface but good performance. There are some stories hidden under the complex interface, as well as the elegant theoretical design of ZeRO-1. This note is to record the stories behind these complex interfaces.</p> <h2 id="i-dauntingly-complex-interface">I. Dauntingly complex interface</h2> <p>DistributedOptimizer has a dauntingly complex interface. I have organized them as follows</p> <p>Basic optimizer functions:</p> <ul> <li>get_parameters</li> <li>zero_grad</li> <li>state_dict</li> <li>load_state_dict</li> <li>step</li> </ul> <p>TP/SP+PP:</p> <ul> <li>get_main_grads_for_grad_norm</li> <li>get_model_parallel_group</li> <li>allreduce_word_embedding_grads</li> <li>allreduce_position_embedding_grads</li> <li>allreduce_embedding_grads</li> <li>allreduce_layernorm_grads</li> <li>allreduce_router_grads</li> </ul> <p>ZeRO:</p> <ul> <li>build_model_gbuf_param_range_map</li> <li>build_model_gbuf_range</li> <li>build_model_gbuf_range_map</li> <li>build_model_param_gbuf_map</li> <li>build_optimizer_group_ranges</li> <li>build_model_and_main_param_groups</li> <li>get_model_param_range_map</li> <li>save_parameter_state</li> <li>load_parameter_state</li> <li>get_model_buffer_dp_views</li> <li>get_model_grad_buffer_dp_views</li> <li>get_model_param_buffer_dp_views</li> <li>reduce_model_grads</li> <li>gather_model_params</li> </ul> <p>Mixprecision:</p> <ul> <li>clip_grad_norm</li> <li>get_loss_scale</li> <li>scale_loss</li> <li>reload_model_params</li> </ul> <p>helpers:</p> <ul> <li>count_zeros</li> </ul> <h2 id="ii-how-is-zero-1-implemented">II. How is ZeRO-1 implemented?</h2> <p>ZeRO-1 is main function of DistributedOptimizer. Before starting the introduction, it is highly recommended to read <a href="https://github.com/NVIDIA/Megatron-LM/blob/main/docs/distrib_optimizer.md" rel="external nofollow noopener" target="_blank">the documentation</a> written by Megatron-LM to DistributedOptimizer first. It’s silky smooth and clear.</p> <p>For ZeRO-1, optimizer state memory space and calculation must be distributed across data parallel ranks. DistributedOptimizer does it in <code class="language-plaintext highlighter-rouge">optimizer.step</code>, and in detail, by reduce-scatter gradients, then update optimizer state and parameters, and finally all-gather updated parameters. This sequence of operations can be visualized in the following data flow figure.</p> <p><img src="/assets/posts/2023-10-27-you-need-to-know-about-megatron-lm-distributedoptimizer/data-flow.png" alt="data flow" width="100%"></p> <p>As can be seen, a key design is that gradients and parameters share the same memory space, and they are evenly divided among DP ranks. This memory space called <code class="language-plaintext highlighter-rouge">gbuf</code> in the code, and many functions here resolve around <code class="language-plaintext highlighter-rouge">gbuf</code> operations.</p> <p><img src="/assets/posts/2023-10-27-you-need-to-know-about-megatron-lm-distributedoptimizer/sharding-scheme.png" alt="sharding scheme" width="100%"></p> <p>In the function <code class="language-plaintext highlighter-rouge">build_model_gbuf_param_range_map</code>, the global and local indexes of all parameters/gradients are constructed. These indexes build on <code class="language-plaintext highlighter-rouge">gbuf</code>, used to divide gradients, parameters, and parameter groups. There are three additional <code class="language-plaintext highlighter-rouge">gbuf</code> functions that provide interface functions around this core function. These are <code class="language-plaintext highlighter-rouge">build_model_gbuf_range</code>, <code class="language-plaintext highlighter-rouge">build_model_gbuf_range_map</code>, and <code class="language-plaintext highlighter-rouge">build_model_param_gbuf_map</code>.</p> <p>The function <code class="language-plaintext highlighter-rouge">build_model_and_main_param_groups</code> completes the operations of partitioning parameters and parameter groupss, which are divided according to the previously calculated index. This function also includes an operation that creates an fp32 copy for the fp16/bf16 parameters.</p> <p>The functions <code class="language-plaintext highlighter-rouge">reduce_model_grads</code> and <code class="language-plaintext highlighter-rouge">gather_model_params</code> execute reduce-scatter and all-gather operations respectively.</p> <p>Here is a brief description of other functions:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">build_optimizer_group_ranges</code> - This function builds a mapping of model parameter and group index for all parameters.</li> <li> <code class="language-plaintext highlighter-rouge">get_model_param_range_map</code> - Given a model parameter, this function retrieves the index sub-range of the parameter that the data-parallel rank owns.</li> <li> <code class="language-plaintext highlighter-rouge">save_parameter_state</code> - This function copies parameters and optimizer shards, gathers them on DP rank 0, and saves them to disk.</li> <li> <code class="language-plaintext highlighter-rouge">load_parameter_state</code> - This function performs the reverse operation of save_parameter_state.</li> <li> <code class="language-plaintext highlighter-rouge">get_model_buffer_dp_views</code> - This function is a <code class="language-plaintext highlighter-rouge">gbuf</code> reader that indexes separately by model id and data type.</li> <li> <code class="language-plaintext highlighter-rouge">get_model_grad_buffer_dp_views</code> - This function is an application of <code class="language-plaintext highlighter-rouge">get_model_buffer_dp_views</code> and is used to read the gradient buffer.</li> <li> <code class="language-plaintext highlighter-rouge">get_model_param_buffer_dp_views</code> - This function is another application of <code class="language-plaintext highlighter-rouge">get_model_buffer_dp_views</code> and is used to read the parameter buffer.</li> </ul> <h2 id="iii-the-story-about-the-gradient-of-moe-router-that-needs-to-be-processed-independently">III. The story about the gradient of MoE router that needs to be processed independently</h2> <h1 id="references">References</h1> <ul> <li><a href="https://github.com/NVIDIA/Megatron-LM/blob/main/docs/distrib_optimizer.md" rel="external nofollow noopener" target="_blank">Megatron-LM Distributed Optimizer Document</a></li> </ul> </div> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"alshedivat/al-folio","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,a])=>giscusScript.setAttribute(t,a)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Jianbin Chang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>